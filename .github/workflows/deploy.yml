name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  DOCKER_IMAGE_NAME: website

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run tests
        run: npm test

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run ESLint
        run: npm run lint

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run security audit
        run: npm audit --audit-level=high

      - name: Generate audit report
        if: always()
        run: npm audit --json > npm-audit-report.json || true

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint, security-audit]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

  docker-build:
    name: Build & Scan Docker Image
    runs-on: ubuntu-latest
    needs: [test, lint, security-audit]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build \
            --build-arg VERSION=$(date +%s) \
            --build-arg NODE_ENV=production \
            --label org.opencontainers.image.revision=${{ github.sha }} \
            --label org.opencontainers.image.source=https://github.com/${{ github.repository }} \
            --label org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            -t ${{ env.DOCKER_IMAGE_NAME }}:latest \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --load .

      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.DOCKER_IMAGE_NAME }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'
          scanners: 'vuln,secret'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.DOCKER_IMAGE_NAME }}:latest
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,secret'
          exit-code: '1'

      - name: Save Docker image
        run: |
          docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | gzip > ${{ env.DOCKER_IMAGE_NAME }}.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v5
        with:
          name: docker-image
          path: ${{ env.DOCKER_IMAGE_NAME }}.tar.gz
          retention-days: 1

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15
    concurrency:
      group: production_environment
      cancel-in-progress: false
    environment:
      name: production
      url: https://loiskauffungen.com
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download image artifact
        uses: actions/download-artifact@v6
        with:
          name: docker-image

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Create deploy folder and transfer image
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.DROPLET_IP }} "mkdir -p ~/deploy"
          scp ${{ env.DOCKER_IMAGE_NAME }}.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.DROPLET_IP }}:~/deploy/

      - name: Deploy to production
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.DROPLET_IP }} "cd ~/deploy && ~/deploy.sh ${{ github.sha }} ${{ env.DOCKER_IMAGE_NAME }}"

      - name: Verify deployment health
        run: |
          echo "Waiting for service to be healthy..."
          sleep 10
          ssh ${{ secrets.SSH_USER }}@${{ secrets.DROPLET_IP }} "docker ps --filter name=${{ env.DOCKER_IMAGE_NAME }} --format '{{.Status}}' | grep -q 'Up'"

      - name: Clean up
        if: always()
        run: |
          rm -f ${{ env.DOCKER_IMAGE_NAME }}.tar.gz
          ssh ${{ secrets.SSH_USER }}@${{ secrets.DROPLET_IP }} "docker image prune -af --filter 'label=org.opencontainers.image.source=https://github.com/${{ github.repository }}' --filter 'until=24h'" || true
